<script>
    let currentTotalPercentage = 0;

    function updateUsedPercentageDisplay() {
        document.getElementById('percentageUsed').textContent = `Procent total folosit: ${currentTotalPercentage.toFixed(2)}%`;
    }

    function createEmptyMessage() {
        const divisionValueList = document.getElementById('divisionValueList');
        if (divisionValueList.children.length === 0) {
            const emptyMessage = document.createElement('li');
            emptyMessage.textContent = "Nicio categorie adăugată.";
            emptyMessage.id = "emptyMessage";
            divisionValueList.appendChild(emptyMessage);
        }
    }

    function removeEmptyMessage() {
        const message = document.getElementById('emptyMessage');
        if (message) message.remove();
    }

    function loadFromLocalStorage() {
        const savedData = JSON.parse(localStorage.getItem('divisionList')) || [];
        currentTotalPercentage = 0;
        document.getElementById('divisionValueList').innerHTML = '';
        savedData.forEach(item => {
            addItemToList(item.name, item.amount, item.percentage);
            currentTotalPercentage += item.percentage;
        });
        updateUsedPercentageDisplay();
        createEmptyMessage();
    }

    function saveToLocalStorage() {
        const items = [];
        document.querySelectorAll('#divisionValueList li').forEach(li => {
            const parts = li.textContent.match(/(.*): ([\d.]+) \(([\d.]+)%\)/);
            if (parts) {
                items.push({
                    name: parts[1],
                    amount: parseFloat(parts[2]),
                    percentage: parseFloat(parts[3])
                });
            }
        });
        localStorage.setItem('divisionList', JSON.stringify(items));
    }

    function addItemToList(name, amount, percentage) {
        removeEmptyMessage();
        const divisionValueList = document.getElementById('divisionValueList');
        const listItem = document.createElement('li');
        listItem.textContent = `${name}: ${amount.toFixed(2)} (${percentage}%)`;

        // Buton de ștergere
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = "✕";
        deleteBtn.style.float = "right";
        deleteBtn.style.border = "none";
        deleteBtn.style.background = "transparent";
        deleteBtn.style.color = "red";
        deleteBtn.style.cursor = "pointer";

        deleteBtn.onclick = function () {
            listItem.remove();
            currentTotalPercentage -= percentage;
            updateUsedPercentageDisplay();
            saveToLocalStorage();
            createEmptyMessage();
        };

        listItem.appendChild(deleteBtn);
        divisionValueList.appendChild(listItem);
    }

    function resetInputs() {
        document.getElementById('divisionName').value = '';
        document.getElementById('percentage').value = '';
    }

    document.getElementById('addDivision').addEventListener('click', function () {
        const totalValue = parseFloat(document.getElementById('totalValue').value);
        const divisionName = document.getElementById('divisionName').value.trim();
        const percentage = parseFloat(document.getElementById('percentage').value);

        if (!divisionName || isNaN(totalValue) || totalValue <= 0 || isNaN(percentage) || percentage <= 0 || percentage > 100) {
            alert("Introduceți un nume valid, o valoare totală numerică pozitivă și un procent între 0 și 100.");
            return;
        }

        if (currentTotalPercentage + percentage > 100) {
            alert("Totalul procentajelor nu poate depăși 100%");
            return;
        }

        const divisionAmount = (totalValue * percentage) / 100;
        addItemToList(divisionName, divisionAmount, percentage);
        currentTotalPercentage += percentage;
        updateUsedPercentageDisplay();
        saveToLocalStorage();
        resetInputs();
    });

    document.getElementById('percentage').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            document.getElementById('addDivision').click();
        }
    });

    // Recalculare când se apasă Enter în câmpul totalValue
    document.getElementById('totalValue').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            const totalValue = parseFloat(document.getElementById('totalValue').value);
            if (isNaN(totalValue) || totalValue <= 0) {
                alert("Introduceți o valoare totală numerică pozitivă.");
                return;
            }

            const savedData = JSON.parse(localStorage.getItem('divisionList')) || [];
            document.getElementById('divisionValueList').innerHTML = '';
            savedData.forEach(item => {
                const newAmount = (totalValue * item.percentage) / 100;
                addItemToList(item.name, newAmount, item.percentage);
            });
            updateUsedPercentageDisplay();
            createEmptyMessage();
        }
    });

    document.getElementById('resetList').addEventListener('click', function () {
        document.getElementById('divisionValueList').innerHTML = '';
        document.getElementById('totalValue').value = '';
        currentTotalPercentage = 0;
        localStorage.removeItem('divisionList');
        updateUsedPercentageDisplay();
        createEmptyMessage();
    });

    // La încărcarea paginii
    window.onload = loadFromLocalStorage;
</script>
